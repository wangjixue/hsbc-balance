# 系统设计

## 战略设计
本系统采用DDD模型进行建模设计,主要分为两大领域，账户域和交易域,
具体业务架构如下：![系统架构图.png](images/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E5%9B%BE.png)

## 战术设计

 - **分层架构**：本系统工程结构使用alibaba-cola分层架构设计，具体详情见[alibaba-cola](https://github.com/alibaba/COLA)
![分层架构.png](images/%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84.png)
 - **CQRS模式** 将命令（写）和查询（读）操作分离
 - **采用事件方式**，异步处理交易操作，账户的转账等
### 数据库设计
整体设计为三张表，DML语句见[database.sql](database.sql)

- **账户表**：账户表是核心主表, 主要记录客户的账号信
- **账户记录表**：记录账户流水数据，用于对账和审计
- **交易单据表**：交易记录表，记录用户交易记录

### 项目工程

本工程使用springboot进行搭建，依赖组件如下：

- spring-boot-starter-web
- mybatis-spring-boot-starter
- spring-boot-starter-data-redis
- spring-boot-starter-aop
- spring-boot-starter-test
- lombok
- mapStruct
- spring-boot-starter-validation
- spring-boot-starter-logging
- mysql
- springEvent
- springThreadPool

### 异常处理
异常处理分为两种情况，外部异常和内部异常
- **内部异常**： 异常处理根据层级不同,进行不同的异常类封装
- **外部异常**：定义异常码，对用户界面友好提示
- 
### 性能
- **使用Redis缓存账户信息**，减少数据库读取压力。
- **幂等处理** 针对transcationId进行唯一性校验，此处使用了数据库设计上设置唯一索引，另外也可以在应用层增加缓存校验，进行防重
- **通过异步事件处理**，提升系统吞吐量, 同时也能保证数据最终一致性。本次实现采用内存事件实现，可以更换为具有重试机制的rocketMQ，保证重试和高可用
- **使用数据库事务和悲观锁**，保证数据一致性。由于时间有限，未采用分布式锁机制来替代数据库悲观锁

### 重试机制
对于核心方法，采用了重试机制，本次使用spring-retry进行重试，不是最优解，方案上应该使用MQ来进行重试，并且需要增加重试次数限制，同时使用定时任务方式针对异常交易进行扫描，如发现异常，人工报警和介入

### 监控
 - 系统监控：
   - 统一使用切面形式，对重要方法进行监控和打印日志
   - 针对内部异常进行分类和优先级监控报警
 - 业务监控
   - 针对交易异常数据进行统计，同比和环比监控

## 部署图
提升可用性和稳定性，每个节点需要都需要多机部署
 ![部署图.png](images/%E9%83%A8%E7%BD%B2%E5%9B%BE.png)

### 部署
 - 最小部署两台实例，防止单点
 - 滚动部署，防止服务不可用
 - 弹性扩缩容机制，CPU大于80%和内存使用率大于90%，动态扩容，限制最大和最小实例数